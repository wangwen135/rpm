## 远程端口映射程序
> rpm =  remote port mapper



**只支持TCP连接**



### 正向端口映射
将公网上的服务端口，映射到本地

**常规**
客户端程序  ----> ~  internet ~ ---->  服务端程序

> 客户端程序直连服务端程序

**经过RPM**
[ 客户端程序 ---->  RPM-client ] ---->  ~  `internet` ~  ---->  [ RPM-server  ----> 服务端程序 ]

> - 客户端程序认为 RPM-client 是服务端  
> - 服务端程序认为 RPM-server 是客户端


### 反向端口映射
用于将局域网电脑的端口映射到公网主机上

**常规**
在有公网IP的服务器上启动程序

**经过RPM**

内网服务（内网端口） <----- RPM-client <------>  ~  `internet` ~  <------>  RPM-server（公网端口）

在内网启动服务，将内网的服务端口通过RPM-server映射到公网上，并对外提供服务



### 客户端
内网机器部署  
主动发起请求连接服务端  

>  RPM客户端 与 RPM服务端保持长连接，客户端发心跳，服务端响应心跳



#### 配置
服务器的IP  
服务器的端口  

认证

正向映射配置客户端



### 服务端
有公网IP的机器部署  
开放端口，接受客户端的连接  

#### 配置
绑定的网口  
绑定的端口  

认证（配置相同的SID）


反向映射配置服务端

配置监听端口



## 加密

支持简单的异或加密处理，key使用SID无须交换秘钥



## 功能模块

1. 配置解析
2. 服务启动
3. 客户端认证、注册
4. 长连接  管理链路 指令包
5. 连接管理器，标记连接，返回最终可用链路
6. 



### 包解析

魔法数字 88 1 byte

包长度 short 2byte

包内容：
- 鉴权包 
- 鉴权结果
- 注册包
- 注册结果
- 心跳包
- 指令包
- 指令结果
- 数据传输包


【魔法数字 1】【类型 1】【长度 4】【对象序列化字节】



### 通信逻辑

心跳包直接跳过



请求认证（客户端CID） 》服务端 生成随机数 使用 sid  作为秘钥对称加密 》 返回给客户端 》客户端使用sid解码随机字符串，然后用cid再次加密》上传给服务端》服务端根据 CID加随机字符串加密后进行对比，通过则返回uuid，保持长连接保存uuid，否则关闭连接



服务端使用sid加密随机数  》 客户端解密后随机数+1 再用sid加密，发送给服务端 》服务端使用sid解密后对比随机数



连接断开时清除uuid

客户端下次与服务建了连接时直接使用uuid，不再鉴权







### 备注

服务端有一个主端口号，用来和客户端进行通信以及验证，反向控制等

需要实现反向功能那服务端就需要监听一个端口，然后将这个端口的数据转发给客户端







