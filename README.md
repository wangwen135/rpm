还没想好做成什么样子

传输层 SSL

零拷贝的ByteBuf缓冲

TCP UDP 支持

应该有一个工具集合
- socketClient
- socketServer
- UDP 工具

大概应该是这个样子

## 远程端口映射程序
> rpm =  remote port mapper



### 正向端口映射
将公网上的服务端口，映射到本地

**常规**
客户端程序  ----> ~  internet ~ ---->  服务端程序

> 客户端程序直连服务端程序

**经过RPM**
[ 客户端程序 ---->  RPM-client ] ---->  ~  internet ~  ---->  [ RPM-server  ----> 服务端程序 ]

> 客户端程序认为 RPM-client 是服务端  
> 服务端程序认为 RPM-server 是客户端


### 反向端口映射
用于将局域网电脑的端口映射到公网主机上


**常规**
在有公网IP的服务器上启动程序


**经过RPM**

内网服务（内网端口） <----- RPM-client <------>  ~  internet ~  <------>  RPM-server（公网端口）

在内网启动服务，将内网的服务端口通过RPM-server映射到公网上，并对外提供服务

此时RPM客户端 与 RPM服务端将保持长连接



### 客户端
内网机器部署  
主动发起请求连接服务端  

#### 配置
服务器的IP  
服务器的端口  

认证

正向映射配置客户端



### 服务端
有公网IP的机器部署  
开发端口，接受客户端的连接  

#### 配置
绑定的网口  
绑定的端口  

认证


反向映射配置服务端

配置监听端口

如果有多个客户端的情况下，反向映射时应该到哪一个客户端，应该加一个id标识



## 数据包定义

不加密 直接流传输

很多网站都是加密过的，问题不大





## 加密解密

应用程序层面进行封包？ 两端再拆包再转发

先实现简单加密



TLS？





## 功能模块

1. 配置解析
2. 服务启动
3. 客户端认证、注册
4. 长连接  管理链路 指令包
5. 连接管理器，标记连接，返回最终可用链路
6. 链路复用？？
7. 自定义数据包格式？？



连接管理器，获取连接，或者叫通道管理器？ChannelManager



### 包解析

魔法数字 88 1 byte

包长度 short 2byte

包内容

​		鉴权包 

​			鉴权结果

​		注册包

​			注册结果

​		心跳包

 		指令包

​			指令结果

​		数据传输包





【魔法数字 1】【类型 1】【长度 4】【对象序列化字节】





心跳包直接跳过

请求认证（客户端CID） 》服务端 生成随机数 使用 sid  作为秘钥对称加密 》 返回给客户端 》客户端使用sid解码随机字符串，然后用cid再次加密》上传给服务端》服务端根据 CID加随机字符串加密后进行对比，通过则返回uuid，保持长连接保存uuid，否则关闭连接



服务端使用sid加密随机数  》 客户端解密后随机数+1 再用sid加密，发送给服务端 》服务端使用sid解密后对比随机数



连接断开时清除uuid

客户端下次与服务建了连接时直接使用uuid，不再鉴权







### 备注

服务端有一个主端口号，用来和客户端进行通信以及验证，反向控制等

需要实现反向功能那服务端就需要监听一个端口，然后将这个端口的数据转发给客户端





#### UDP直连

试试udp改源端口号的功能来实现 通过udp协议实现跨网络直连。。。

这个取决于出口设备的nat功能等，可能复杂网络下行不通

google好像有一个基于udp协议的封装，实现udp下的稳定通信



